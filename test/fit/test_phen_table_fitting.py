from adel.fit.phen_table_fitting import create_id_phen_list,\
    create_index_rel_phytomer_list, find_most_frequent_id_phen_list,\
    create_TT_col_phytomer_list
import numpy
import pandas

id_phen_from_axis_table_list = ['110', '308', '407', '506', '111', '308', '408', '508', '508', '111', '308', '408', '508', '114', '312', '411', '510', '114', '311', '410', '510', '510', '114', '311', '411', '511', '510', '114', '311', '411', '510', '113', '311', '410', '509', '114', '311', '411', '510', '510', '114', '312', '411', '510', '114', '311', '411', '510', '510', '113', '310', '410', '509', '112', '309', '409', '509', '114', '311', '411', '114', '312', '411', '511', '114', '312', '411', '113', '310', '410', '510', '509', '113', '311', '410', '510', '509', '114', '311', '411', '510', '110', '308', '407', '507', '114', '312', '411', '510', '114', '311', '411', '510', '114', '311', '411', '510', '114', '311', '411', '510', '511', '114', '312', '411', '510', '114', '312', '411', '511', '510', '114', '312', '411', '114', '311', '411', '510', '510', '112', '309', '409', '509', '508', '114', '311', '411', '510', '510', '111', '308', '408', '508', '114', '312', '411', '510', '114', '311', '411', '511', '510', '113', '311', '410', '510', '111', '309', '408', '508', '507', '113', '310', '410', '509', '510', '114', '312', '411', '511', '114', '311', '411', '510', '114', '311', '411', '112', '309', '409', '508', '113', '310', '410', '509', '114', '312', '411', '511', '113', '310', '410', '510', '112', '309', '409', '508', '508', '112', '310', '409', '509', '110', '308', '408', '506', '506', '113', '311', '411', '510', '111', '309', '408', '114', '312', '411', '510', '510', '111', '309', '408', '114', '312', '411', '511', '111', '308', '409', '508', '114', '311', '411', '510', '511', '113', '311', '410', '510', '110', '308', '407', '114', '311', '411', '510', '114', '311', '411', '510', '114', '312', '411', '114', '311', '411', '511', '510', '112', '309', '410', '509', '509', '114', '312', '411', '510', '112', '310', '409', '508', '509', '114', '312', '411', '510', '114', '311', '411', '511', '114', '311', '411', '511', '511', '112', '310', '409', '509', '114', '312', '411', '511', '112', '309', '410', '509', '111', '309', '408', '507', '114', '311', '411', '510', '114', '311', '411', '511', '510', '111', '308', '408', '507', '508', '110', '307', '408', '111', '309', '408', '507', '114', '312', '411', '114', '312', '411', '510', '111', '309', '408', '507', '114', '312', '411', '510', '114', '311', '411', '510', '510', '114', '311', '411', '510', '114', '311', '411', '510', '114', '312', '411', '510', '510', '114', '311', '411', '510', '510', '114', '312', '411', '510', '111', '309', '408', '507', '507', '110', '308', '407', '507', '506', '111', '309', '408', '114', '312', '411', '511', '510', '112', '310', '409', '508', '112', '309', '409', '509', '509', '111', '309', '408', '508', '114', '311', '411', '510', '114', '312', '411', '114', '311', '411', '114', '311', '411', '111', '309', '408', '507', '114', '312', '411', '510', '114', '311', '411', '510', '510', '114', '312', '411', '510', '114', '312', '411', '510']
expected_id_phen_list = ['110', '110', '110', '110', '110', '110', '110', '110', '110', '110', '110', '111', '111', '111', '111', '111', '111', '111', '111', '111', '111', '111', '111', '112', '112', '112', '112', '112', '112', '112', '112', '112', '112', '112', '112', '112', '113', '113', '113', '113', '113', '113', '113', '113', '113', '113', '113', '113', '113', '113', '114', '114', '114', '114', '114', '114', '114', '114', '114', '114', '114', '114', '114', '114', '114', '307', '307', '307', '307', '307', '307', '307', '307', '308', '308', '308', '308', '308', '308', '308', '308', '308', '309', '309', '309', '309', '309', '309', '309', '309', '309', '309', '310', '310', '310', '310', '310', '310', '310', '310', '310', '310', '310', '311', '311', '311', '311', '311', '311', '311', '311', '311', '311', '311', '311', '312', '312', '312', '312', '312', '312', '312', '312', '312', '312', '312', '312', '312', '407', '407', '407', '407', '407', '407', '407', '407', '408', '408', '408', '408', '408', '408', '408', '408', '408', '409', '409', '409', '409', '409', '409', '409', '409', '409', '409', '410', '410', '410', '410', '410', '410', '410', '410', '410', '410', '410', '411', '411', '411', '411', '411', '411', '411', '411', '411', '411', '411', '411', '506', '506', '506', '506', '506', '506', '506', '507', '507', '507', '507', '507', '507', '507', '507', '508', '508', '508', '508', '508', '508', '508', '508', '508', '509', '509', '509', '509', '509', '509', '509', '509', '509', '509', '510', '510', '510', '510', '510', '510', '510', '510', '510', '510', '510', '511', '511', '511', '511', '511', '511', '511', '511', '511', '511', '511', '511']    
expected_index_rel_phytomer_list = [0.0, 0.10000000000000001, 0.20000000000000001, 0.29999999999999999, 0.40000000000000002, 0.5, 0.59999999999999998, 0.69999999999999996, 0.80000000000000004, 0.90000000000000002, 1.0, 0.0, 0.090909090909090912, 0.18181818181818182, 0.27272727272727271, 0.36363636363636365, 0.45454545454545453, 0.54545454545454541, 0.63636363636363635, 0.72727272727272729, 0.81818181818181823, 0.90909090909090906, 1.0, 0.0, 0.083333333333333329, 0.16666666666666666, 0.25, 0.33333333333333331, 0.41666666666666669, 0.5, 0.58333333333333337, 0.66666666666666663, 0.75, 0.83333333333333337, 0.91666666666666663, 1.0, 0.0, 0.076923076923076927, 0.15384615384615385, 0.23076923076923078, 0.30769230769230771, 0.38461538461538464, 0.46153846153846156, 0.53846153846153844, 0.61538461538461542, 0.69230769230769229, 0.76923076923076927, 0.84615384615384615, 0.92307692307692313, 1.0, 0.0, 0.071428571428571425, 0.14285714285714285, 0.21428571428571427, 0.2857142857142857, 0.35714285714285715, 0.42857142857142855, 0.5, 0.5714285714285714, 0.6428571428571429, 0.7142857142857143, 0.7857142857142857, 0.8571428571428571, 0.9285714285714286, 1.0, 0.0, 0.14285714285714285, 0.2857142857142857, 0.42857142857142855, 0.5714285714285714, 0.7142857142857143, 0.8571428571428571, 1.0, 0.0, 0.125, 0.25, 0.375, 0.5, 0.625, 0.75, 0.875, 1.0, 0.0, 0.1111111111111111, 0.22222222222222221, 0.33333333333333331, 0.44444444444444442, 0.55555555555555558, 0.66666666666666663, 0.77777777777777779, 0.88888888888888884, 1.0, 0.0, 0.10000000000000001, 0.20000000000000001, 0.29999999999999999, 0.40000000000000002, 0.5, 0.59999999999999998, 0.69999999999999996, 0.80000000000000004, 0.90000000000000002, 1.0, 0.0, 0.090909090909090912, 0.18181818181818182, 0.27272727272727271, 0.36363636363636365, 0.45454545454545453, 0.54545454545454541, 0.63636363636363635, 0.72727272727272729, 0.81818181818181823, 0.90909090909090906, 1.0, 0.0, 0.083333333333333329, 0.16666666666666666, 0.25, 0.33333333333333331, 0.41666666666666669, 0.5, 0.58333333333333337, 0.66666666666666663, 0.75, 0.83333333333333337, 0.91666666666666663, 1.0, 0.0, 0.14285714285714285, 0.2857142857142857, 0.42857142857142855, 0.5714285714285714, 0.7142857142857143, 0.8571428571428571, 1.0, 0.0, 0.125, 0.25, 0.375, 0.5, 0.625, 0.75, 0.875, 1.0, 0.0, 0.1111111111111111, 0.22222222222222221, 0.33333333333333331, 0.44444444444444442, 0.55555555555555558, 0.66666666666666663, 0.77777777777777779, 0.88888888888888884, 1.0, 0.0, 0.10000000000000001, 0.20000000000000001, 0.29999999999999999, 0.40000000000000002, 0.5, 0.59999999999999998, 0.69999999999999996, 0.80000000000000004, 0.90000000000000002, 1.0, 0.0, 0.090909090909090912, 0.18181818181818182, 0.27272727272727271, 0.36363636363636365, 0.45454545454545453, 0.54545454545454541, 0.63636363636363635, 0.72727272727272729, 0.81818181818181823, 0.90909090909090906, 1.0, 0.0, 0.16666666666666666, 0.33333333333333331, 0.5, 0.66666666666666663, 0.83333333333333337, 1.0, 0.0, 0.14285714285714285, 0.2857142857142857, 0.42857142857142855, 0.5714285714285714, 0.7142857142857143, 0.8571428571428571, 1.0, 0.0, 0.125, 0.25, 0.375, 0.5, 0.625, 0.75, 0.875, 1.0, 0.0, 0.1111111111111111, 0.22222222222222221, 0.33333333333333331, 0.44444444444444442, 0.55555555555555558, 0.66666666666666663, 0.77777777777777779, 0.88888888888888884, 1.0, 0.0, 0.10000000000000001, 0.20000000000000001, 0.29999999999999999, 0.40000000000000002, 0.5, 0.59999999999999998, 0.69999999999999996, 0.80000000000000004, 0.90000000000000002, 1.0, 0.0, 0.090909090909090912, 0.18181818181818182, 0.27272727272727271, 0.36363636363636365, 0.45454545454545453, 0.54545454545454541, 0.63636363636363635, 0.72727272727272729, 0.81818181818181823, 0.90909090909090906, 1.0]
expected_most_frequent_id_phen_list = ['114', '311', '411', '510']
expected_TT_col_phytomer_linear_list = [0.0, 98.039215686274503, 196.07843137254901, 294.11764705882354, 392.15686274509801, 490.19607843137254, 588.23529411764707, 686.27450980392155, 784.31372549019602, 882.35294117647049, 980.39215686274508, 0.0, 98.039215686274503, 196.07843137254901, 294.11764705882354, 392.15686274509801, 490.19607843137254, 588.23529411764707, 686.27450980392155, 784.31372549019602, 882.35294117647049, 980.39215686274508, 1078.4313725490194, 0.0, 98.039215686274503, 196.07843137254901, 294.11764705882354, 392.15686274509801, 490.19607843137254, 588.23529411764707, 686.27450980392155, 784.31372549019602, 882.35294117647049, 980.39215686274508, 1078.4313725490194, 1176.4705882352941, 0.0, 98.039215686274503, 196.07843137254901, 294.11764705882354, 392.15686274509801, 490.19607843137254, 588.23529411764707, 686.27450980392155, 784.31372549019602, 882.35294117647049, 980.39215686274508, 1078.4313725490194, 1176.4705882352941, 1274.5098039215686, 0.0, 98.039215686274503, 196.07843137254901, 294.11764705882354, 392.15686274509801, 490.19607843137254, 588.23529411764707, 686.27450980392155, 784.31372549019602, 882.35294117647049, 980.39215686274508, 1078.4313725490194, 1176.4705882352941, 1274.5098039215686, 1372.5490196078431, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 684.67450980392152, 782.71372549019611, 880.75294117647059, 978.79215686274506, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 684.67450980392152, 782.71372549019611, 880.75294117647059, 978.79215686274506, 1076.8313725490195, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 684.67450980392152, 782.71372549019611, 880.75294117647059, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 684.67450980392152, 782.71372549019611, 880.75294117647059, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 1272.9098039215687, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 684.67450980392152, 782.71372549019611, 880.75294117647059, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 1272.9098039215687, 1370.949019607843, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 684.67450980392152, 782.71372549019611, 880.75294117647059, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 1272.9098039215687, 1370.949019607843, 1468.9882352941177, 390.55686274509804, 488.59607843137258, 586.63529411764705, 684.67450980392164, 782.71372549019611, 880.75294117647059, 978.79215686274506, 1076.8313725490195, 390.55686274509804, 488.59607843137258, 586.63529411764705, 684.67450980392164, 782.71372549019611, 880.75294117647059, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 390.55686274509804, 488.59607843137258, 586.63529411764705, 684.67450980392164, 782.71372549019611, 880.75294117647059, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 1272.9098039215685, 390.55686274509804, 488.59607843137258, 586.63529411764705, 684.67450980392164, 782.71372549019611, 880.75294117647059, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 1272.9098039215685, 1370.9490196078432, 390.55686274509804, 488.59607843137258, 586.63529411764705, 684.67450980392164, 782.71372549019611, 880.75294117647059, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 1272.9098039215685, 1370.9490196078432, 1468.9882352941174, 488.59607843137246, 586.63529411764694, 684.67450980392141, 782.713725490196, 880.75294117647047, 978.79215686274506, 1076.8313725490195, 488.59607843137246, 586.63529411764694, 684.67450980392141, 782.713725490196, 880.75294117647047, 978.79215686274506,1076.8313725490195, 1174.870588235294, 488.59607843137246, 586.63529411764694, 684.67450980392141, 782.713725490196, 880.75294117647047, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 1272.9098039215685, 488.59607843137246, 586.63529411764694, 684.67450980392141, 782.713725490196, 880.75294117647047, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 1272.9098039215685, 1370.949019607843, 488.59607843137246, 586.63529411764694, 684.67450980392141, 782.713725490196, 880.75294117647047, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 1272.9098039215685, 1370.949019607843, 1468.9882352941177, 488.59607843137246, 586.63529411764694, 684.67450980392141, 782.713725490196, 880.75294117647047, 978.79215686274506, 1076.8313725490195, 1174.870588235294, 1272.9098039215685, 1370.949019607843, 1468.9882352941177, 1567.0274509803919]
expected_TT_col_phytomer_bilinear_list = [0.0, 98.039215686274503, 196.07843137254901, 294.11764705882354, 392.15686274509801, 490.19607843137254, 588.2938237057765, 710.72036777933238, 833.14691185288825, 955.57345592644413, 1078.0, 0.0, 98.039215686274503, 196.07843137254901, 294.11764705882354, 392.15686274509801, 490.19607843137254, 588.24684621969686, 691.09943776007117, 793.95202930044559, 896.80462084082001, 999.65721238119431, 1102.5098039215686, 0.0, 98.039215686274503, 196.07843137254901, 294.11764705882354, 392.15686274509801, 490.19607843137254, 588.21552163448348, 678.01620266925909, 767.81688370403469, 857.61756473881042, 947.41824577358602, 1037.2189268083616, 1127.0196078431372, 0.0, 98.039215686274503, 196.07843137254901, 294.11764705882354, 392.15686274509801, 490.19607843137254, 588.19314386328051, 668.66975356348405, 749.1463632636877, 829.62297296389136, 910.0995826640949, 990.57619236429855, 1071.0528020645022, 1151.5294117647059, 0.0, 98.039215686274503, 196.07843137254901, 294.11764705882354, 392.15686274509801, 490.19607843137254, 588.17635885704874, 661.659215960702, 735.14207306435515, 808.6249301680084, 882.10778727166166, 955.59064437531492, 1029.073501478968, 1102.5563585826212, 1176.0392156862745, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 712.6799662826636, 839.11997752177581, 965.5599887608879, 1092.0, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 687.67435741103225, 788.75576805827427, 889.83717870551618, 990.91858935275809, 1092.0, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 671.02333413519364, 755.21866730815486, 839.4140004811162, 923.60933365407755, 1007.8046668270388, 1092.0, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 659.13922543114302, 731.28268785928594, 803.42615028742875, 875.56961271557157, 947.71307514371438, 1019.8565375718572, 1092.0, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 650.23132250115191, 713.34113357241597, 776.45094464368003, 839.56075571494398, 902.67056678620793, 965.78037785747199, 1028.8901889287361, 1092.0, 292.51764705882351, 390.55686274509799, 488.59607843137252, 586.63529411764705, 643.30601997756526, 699.39276748036957, 755.47951498317389, 811.56626248597831, 867.65300998878263, 923.73975749158694, 979.82650499439137, 1035.9132524971956, 1092.0, 390.55686274509804, 488.59607843137258, 586.63529411764705, 689.0587234861855, 791.54404261463924, 894.02936174309275, 996.51468087154649, 1099.0, 390.55686274509804, 488.59607843137258, 586.63529411764705, 672.17643599818246, 757.54114879854592, 842.9058615989095, 928.27057439927307, 1013.6352871996364, 1099.0, 390.55686274509804, 488.59607843137258, 586.63529411764705, 660.1272702287979, 733.27272519066491, 806.41818015253193, 879.56363511439895, 952.70909007626597, 1025.854545038133, 1099.0, 390.55686274509804, 488.59607843137258, 586.63529411764705, 651.09564642477915, 715.0819826498107, 779.06831887484225, 843.0546550998738, 907.04099132490535, 971.0273275499369, 1035.0136637749683, 1099.0, 390.55686274509804, 488.59607843137258, 586.63529411764705, 644.07415914392038, 700.93988925093038, 757.80561935794026, 814.67134946495025, 871.53707957196025, 928.40280967897013, 985.26853978598012, 1042.13426989299, 1099.0, 488.59607843137246, 586.63529411764694, 690.44308956133864, 794.33231717100398, 898.22154478066932, 1002.1107723903347, 1106.0, 488.59607843137246, 586.63529411764694, 673.32953786117116, 759.86363028893697, 846.39772271670267, 932.93181514446837, 1019.4659075722343, 1106.0, 488.59607843137246, 586.63529411764694, 661.11531502645255, 735.26276252204377, 809.41021001763499, 883.55765751322633, 957.70510500881755, 1031.8525525044088, 1106.0, 488.59607843137246, 586.63529411764694, 651.95997034840616, 716.82283172720531, 781.68569310600435, 846.5485544848035, 911.41141586360266, 976.27427724240169, 1041.1371386212008, 1106.0, 488.59607843137246, 586.63529411764694, 644.8422983102754, 702.48701102149096, 760.13172373270652, 817.77643644392219, 875.42114915513775, 933.06586186635332, 990.71057457756888, 1048.3552872887844, 1106.0, 488.59607843137246, 586.63529411764694, 639.15014500184247, 691.02235111274888, 742.89455722365528, 794.76676333456169, 846.63896944546809, 898.51117555637438, 950.38338166728079, 1002.2555877781872, 1054.1277938890935, 1106.0]


def test_create_id_phen_list():
    id_phen_list = create_id_phen_list(id_phen_from_axis_table_list)
    assert id_phen_list == expected_id_phen_list
    

def test_create_index_rel_phytomer_list():
    index_rel_phytomer_list = create_index_rel_phytomer_list(expected_id_phen_list)
    assert index_rel_phytomer_list == expected_index_rel_phytomer_list


def test_find_most_frequent_id_phen_list():
    most_frequent_id_phen_list = find_most_frequent_id_phen_list(id_phen_from_axis_table_list)
    assert most_frequent_id_phen_list == expected_most_frequent_id_phen_list


def test_create_TT_col_phytomer_list():
    # prepare the minimum input data for TT_col_phytomer_list creation
    id_phen_without_duplicate_list = list(set(expected_id_phen_list))
    id_phen_without_duplicate_list.sort()
    a_cohort_list = [numpy.nan for i in range(len(id_phen_without_duplicate_list) - 1)]
    a_cohort_list.insert(0, 0.0102)
    TT_col_0_list = [numpy.nan for i in range(len(id_phen_without_duplicate_list) - 1)]
    TT_col_0_list.insert(0, 0.0)
    TT_HS_break_list = [numpy.nan for i in range(len(id_phen_without_duplicate_list) - 1)]
    TT_HS_break_list.insert(0, 588.0)
    TT_HS_NFF_list = [numpy.nan for i in range(len(id_phen_without_duplicate_list) - 1)]
    TT_HS_NFF_list.insert(0, 1078.0)
    TT_parameters_array = numpy.array([id_phen_without_duplicate_list, a_cohort_list, TT_col_0_list, TT_HS_break_list, TT_HS_NFF_list]).transpose()
    TT_parameters_dataframe = pandas.DataFrame(TT_parameters_array, columns=['id_phen', 'a_cohort', 'TT_col_0', 'TT_HS_break', 'TT_HS_NFF'], dtype=float)
    dTT_flo_MS_list = [i * 7.0 for i in range(1, len(expected_most_frequent_id_phen_list) + 1)]
    flowering_dTT_array = numpy.array([expected_most_frequent_id_phen_list, dTT_flo_MS_list]).transpose()
    flowering_dTT_dataframe = pandas.DataFrame(flowering_dTT_array, columns=['id_phen', 'dTT_flo_MS'], dtype=float)
    # test with linear calculation method
    TT_col_phytomer_linear_list = create_TT_col_phytomer_list(TT_parameters_dataframe, flowering_dTT_dataframe, calculation_method='linear')
    assert TT_col_phytomer_linear_list == expected_TT_col_phytomer_linear_list
    # test with bilinear calculation method
    TT_col_phytomer_bilinear_list = create_TT_col_phytomer_list(TT_parameters_dataframe, flowering_dTT_dataframe, calculation_method='bilinear')    
    assert TT_col_phytomer_bilinear_list == expected_TT_col_phytomer_bilinear_list
    
    


